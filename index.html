<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OS</title>
</head>
<body oncontextmenu="return false">

<img id="star" width="200" height="220" src="assets/star.png" hidden>
<img id="login" width="200" height="220" src="assets/login.png" hidden>
<canvas id="os" width="1450" height="789" tabindex='1'>
    Your browser does not support the HTML canvas tag.</canvas>
    <div id="List"></div>

<script>
    var canvas = document.getElementById("os");
    var ctx = canvas.getContext("2d");
    var clickableElements = [];
    var windows = [];
    ctx.font = "30px Arial";
    function createClick(x, y, width, height, clicked){
        clickableElements.push({x:x, y:y, width:width, height:height, code:clickableElements.length, functionOnClicked:clicked});
    };
    canvas.addEventListener('click', function(event) {
        const rect = canvas.getBoundingClientRect(); // Get canvas bounds
        const mouseX = event.clientX - rect.left; // Mouse X position relative to canvas
        const mouseY = event.clientY - rect.top; // Mouse Y position relative to canvas
        clickableElements.forEach((el) => {
        if (mouseX > el.x && mouseX < el.x + el.width && mouseY > el.y && mouseY < el.y + el.height) {
            el.functionOnClicked();
        }
        });
    });
    function createButton(x, y, width, height, title){
        ctx.fillStyle = "grey";
        ctx.fillRect(x, y, width, height);
        ctx.font = "20px Arial";
        ctx.fillStyle = "black";
        const textMetrics = ctx.measureText(title);
        const textWidth = textMetrics.width;
        ctx.fillText(title, x + (width - textWidth) / 2, y + (height + parseInt(ctx.font, 10)) / 2 - 5);
    };
    function createOnClickButton(x, y, width, height, title, onClick){
        createButton(x, y, width, height, title);
        createClick(x, y, width, height, onClick);
    };
    var inputNum = 0;
    function addInput(x, y, id=0) {

    var input = document.createElement('input');

    input.type = 'text';
    input.style.position = 'absolute';
    input.style.left = (x - 4) + 'px';
    input.style.top = (y - 4) + 'px';
    if (!id) {
        input.id = inputNum + "Id";
    }else {
        input.id = id;
    }
    inputNum++;

    input.onkeydown = handleEnter;

    document.getElementById("List").appendChild(input);

    // input.focus();

    hasInput = true;
    }

    //Key handler for input box:
    function handleEnter(e) {
    var keyCode = e.keyCode;
    if (keyCode === 13) {
        drawText(this.value, parseInt(this.style.left, 10), parseInt(this.style.top, 10));
        document.body.removeChild(this);
        hasInput = false;
    }
    }

    //Draw the text onto canvas:
    function drawText(txt, x, y) {
    ctx.textBaseline = 'top';
    ctx.textAlign = 'left';
    ctx.font = font;
    ctx.fillText(txt, x - 4, y - 4);
    }
    function CreateDropDown(x, y){
        // Create Select
        select = document.createElement("select");
        select.style.position = 'absolute';
        select.style.left = (x - 4) + 'px';
        select.style.top = (y - 4) + 'px';
        select.id = inputNum+"Id";
        inputNum++;
        return select;
    };

    change = [inputNum];
    function CustomerDifficultyLogin(x, y, method){
        ctx.fillText("We're sorry to hear that! Please tell us about your experience.", x, y+350);
        change.push(inputNum);
        addInput(x+450, y+350, "CustomerDifficulty");
        createOnClickButton(x, y+380, 100, 40, "Send", (send)=>{
            send_to = "Vishnu Ramesh";
            if (method == "TVA"){
                send_to = "Joseph Mattucci";
            };
            ctx.fillText("To "+send_to+",", x, y+500, 1450);
            ctx.fillText("  I have a problem with "+method+". My name is ____.", x, y+520, 1450);
            ctx.fillText("  My problem is that "+document.getElementById("CustomerDifficulty").value+".", x, y+540, 1450);
            ctx.fillText("  Please try to fix it! ", x, y+560, 1450);
            if (send_to == "Vishnu Ramesh") {
            ctx.fillText("  Email this to vishnuram9120@k12.ipsd.org", x, y+580, 1450);
            }else if (send_to == "Joseph Mattucci") {
            ctx.fillText("  Email this to josephmat9428@k12.ipsd.org", x, y+580, 1450);
            }
            email_prompt = "To "+send_to+", \n  I have a problem with "+method+". My name is ____.\n  My problem is that "+document.getElementById("CustomerDifficulty").value+".\n  Please try to fix it! ";
            createOnClickButton(x, y+590, 100, 40, "Copy", (send)=>{
                navigator.clipboard.writeText(email_prompt);
            })
        });
    };

    function LoginApp(x, y, method){
        ctx.font = "20px Arial";
        ctx.fillText("Please fill out the following form", x, y+200);
        ctx.font = "15px Arial";
        ctx.fillText("What is your purpose of coming here? ", x+20, y+300);
        select1 = CreateDropDown(x+300, y+300);
        select1.innerHTML = "<option value=1>Customer Difficulty</option><option value=2>Enrollment</option><option value=3>Contract</option>";
        change = []
        CustomerDifficultyLogin(x, y, method)
        select1.addEventListener("change", (event)=>{
            // ctx.clearRect(x+2, y+250, 500, 80);
            // if (change.length != 1) {
                change.forEach((item) => {
                    if (document.getElementById((item) + "Id") != null) {
                        console.log(item, document.getElementById((item) + "Id"));
                        document.getElementById("List").removeChild(document.getElementById((item) + "Id"));
                    }
                });
            // }
            ctx.clearRect(x+1, y+310, 1000, 200);
            // ctx.clearRect(x, y+380, 200, 300);
            for (i=0;i<=clickableElements.length; i++){
                if (clickableElements[i]) {
                    if (clickableElements[i].x == x && clickableElements[i].y == y+380 && clickableElements[i].width==100 && clickableElements[i].width==40) {
                        console.log("Hi");
                        clickableElements.splice(i, 1);
                    }
                }
            };
            if (select1.value == 1){
                change.push(inputNum);
                CustomerDifficultyLogin(x, y, method)
            }else if (select1.value == 2){
                ctx.fillText("Tell me something good about you that could help us. Be short in your description.", x+1, y+350);
                // change.add(inputNum);
                addInput(x+560, y+350, "GoodLogin");
                createOnClickButton(x, y+380, 100, 40, "Send", (send)=>{
                    // document.getElementById("GoodLogin").value;
                    send_to = "Vishnu Ramesh";
                    if (method == "TVA"){
                        send_to = "Joseph Mattuci";
                    };
                    ctx.fillText("To "+send_to+",", x, y+500, 1450);
                    ctx.fillText("  I want to enroll into "+method+". My name is ____.", x, y+520, 1450);
                    ctx.fillText("  One thing that is good about me is that I can "+document.getElementById("GoodLogin").value+".", x, y+540, 1450);
                    ctx.fillText("  Please respond with a location to meet! ", x, y+560, 1450);
                    if (send_to == "Vishnu Ramesh") {
                    ctx.fillText("  Email this to vishnuram9120@k12.ipsd.org", x, y+580, 1450);
                    }else if (send_to == "Joseph Mattucci") {
                    ctx.fillText("  Email this to josephmat9428@k12.ipsd.org", x, y+580, 1450);
                    }
                    email_prompt = "To "+send_to+", \n  I want to enroll into "+method+". My name is ____.\n  One thing that is good about me is that I can "+document.getElementById("GoodLogin").value+"\n  Please respond with a location to meet! ";
                    createOnClickButton(x, y+590, 100, 40, "Copy", (send)=>{
                        navigator.clipboard.writeText(email_prompt);
                    })
                });
            }else if (select1.value == 3){
                ;
            };
        });
        document.getElementById("List").appendChild(select1);
    };
    function Setup(x, y, width, height, title, win){
        if (win.name == "RedGame"){
            ctx.font = "80px Roboto";
            ctx.fillText("Games", x, y+100);
            ctx.font = "20px Arial";
        }else if(win.name == "Login"){
            ctx.fillText("Login", x, y+100);
            // Create Select
            select = CreateDropDown(x+20, y+150)
            select.innerHTML = "<option value=0 selected>None</option><option value=1>TVA</option><option value=2>Epic Games</option>";
            document.getElementById("List").appendChild(select);
            select.addEventListener("change", (event)=>{
                document.getElementById("List").innerHTML = "";
                document.getElementById("List").appendChild(select);
                if (select.value == 1){
                    LoginApp(x, y, "TVA");
                }else if (select.value == 2){
                    LoginApp(x, y, "EpicGames");
                }else {
                    select.value = 2;
                };
                // addInput(x+50, y+200);
            });
            // Add input
        };
    };
    function MoveLeft(layer){
        if (layer == -1 && layer < windows.length){
            if (windows.length != 1) {
                layer = windows.length-1;
            }else{
                layer = 1;
            }
        };
        windows[layer].ImageData = ctx.getImageData(0, 40, 1400, 700);
        if(layer > 0){
            ctx.putImageData(windows[layer-1].ImageData, 0, 40);
        }
        if (layer-1 != -1) {
        layer--;
        }

        clickableElements.splice(2);
        x = 0, y=40, width=1400, height=700;
                win = windows[layer];
                createClick(x+width-90, y, 10, 30, ()=>{
                    if (layer == 0){
                        layer = MoveRight(win.layer);
                    }else {
                        layer = MoveLeft(win.layer);
                    };
                });
                createClick(x+width-30, y, 10, 30, ()=>{
                    CloseWindow(win, x, y, width, height);
                });
                createClick(x+width-60, y, 10, 30, ()=>{
                    console.log("BOX");
                });
        return layer;
    };
    function MoveRight(layer){
        if (layer != -1 && layer < windows.length){
            windows[layer].ImageData = ctx.getImageData(0, 40, 1400, 700);
            if (layer + 1 != windows.length) {
                ctx.putImageData(windows[layer+1].ImageData, 0, 40);
                layer++;
                clickableElements.splice(2);
                win = windows[layer];
                x = 0, y=40, width=1400, height=700;
                createClick(x+width-90, y, 10, 30, ()=>{
                    if (layer == 0){
                        layer = MoveRight(win.layer);
                    }else {
                        layer = MoveLeft(win.layer);
                    };
                });
                createClick(x+width-30, y, 10, 30, ()=>{
                    CloseWindow(win, x, y, width, height);
                });
                createClick(x+width-60, y, 10, 30, ()=>{
                    console.log("BOX");
                });
            }
        }
        return layer;
    };
    function CloseWindow(win, x, y, width, height){
        win.ImageData = ctx.getImageData(x, y, width, height);
        windows = windows.filter((_, index) => index !== win.id);
        ctx.clearRect(x, y, width+1, height+1);
        ctx.fillStyle = "white";
        for (let i = windows.length - 1; i >= 0; i--) {
            if (windows[i] === 0) {
                windows.splice(i, 1); // Remove element at index i
            }
        }
        // ctx.clearRect(windows.length * 100, 30, ctx.measureText(winname).width(), 30);
        console.log(clickableElements, windows);
        ctx.fillStyle = "black";
        ctx.fillRect(0, 0, 1700, 40);
        ctx.fillStyle = "white";
        var idx = 0
        windows.forEach((el) => {
            console.log("Hi", String(el.winname));
            ctx.fillText(String(el.winname), idx * 100, 30);
            idx = idx + 1
        });
    };
    function Window1(x, y, width, height, title, win){
        clickableElements = JSON.parse("[{\"x\":0,\"y\":740,\"width\":110,\"height\":50,\"code\":0},{\"x\":120,\"y\":743,\"width\":48,\"height\":48,\"code\":1},{\"x\":180,\"y\":747,\"width\":40,\"height\":40,\"code\":2}]");
        clickableElements[0].functionOnClicked = (event) => {
            console.log("Opening the time");
        };
        clickableElements[1].functionOnClicked = (event) => {
            Game("RedGame");
        };
        clickableElements[2].functionOnClicked = (event) => {
            Game("Login");
        };
        Setup(x, y, width, height, title, win);
        win.ImageData = ctx.getImageData(x, y, width, height);
        ctx.rect(x, y, width, height);
        ctx.stroke();
        ctx.rect(x, y, width, 30);
        ctx.stroke();
        ctx.fillText(title, x+10, y+25);
        ctx.fillStyle = "black";
        ctx.fillText("-", x+width-90, y+25);
        ctx.fillText("x", x+width-30, y+25);
        ctx.fillText("â– ", x+width-60, y+25);
        win.ImageData = ctx.getImageData(x, y, width, height);
        createClick(x+width-90, y, 10, 30, ()=>{
            if (layer == 0){
                layer = MoveRight(win.layer);
            }else {
                layer = MoveLeft(win.layer);
            };
        });
        createClick(x+width-30, y, 10, 30, ()=>{
            CloseWindow(win, x, y, width, height);
            document.getElementById("List").innerHTML = "";
        });
        createClick(x+width-60, y, 10, 30, ()=>{
            console.log("BOX");
        });
    };
    function Game(name){
        winname = windows.length;
        ctx.clearRect(0, 40, 900, 700);
        ctx.fillStyle = "white";
        ctx.fillText(winname, windows.length * 100, 30);
        win = {name:name, layer:windows.length, id:windows.length, winname:winname};
        windows.push(win);
        ctx.fillStyle = "black";
        Window1(0, 40, 1400, 700, winname, win);
    };
    if (!localStorage.OSBooted) {
        localStorage.OSBooted = true;
        ctx.rect(10,15,300,200);
        ctx.stroke();
        ctx.fillText("Welcome To", 80, 50);
        ctx.font = "50px Arial";
        ctx.fillText("VishnuOS", 50, 100);
        createOnClickButton(105, 150, 100, 40, "Tutorial", (click) => {
            ctx.clearRect(0, 0, 1000, 1000);
            ctx.fillText("No thank you. Just go back. At least you learned that Ctrl-Y opens the view to see your windows! Also Esc brings you to the page mode where you can choose", 40, 50, 2000);
            ctx.fillText("your page and can go back by pressing p.", 40, 80, 2000);
            createOnClickButton(80, 100, 100, 40, "Go Back", (click) => {
                localStorage.OSBooted = false;
                window.location.reload();
            });
        });
    }else {
        var _ImageData;
        var mode = 0;
        var layer = -1;
        ctx.fillRect(0, 0, 1700, 40);
        document.onkeydown = (e) => {
            if (e.key == 123) {
                e.preventDefault();
            }
            if (e.ctrlKey && e.shiftKey && e.key == 'I') {
                e.preventDefault();
            }
            if (e.ctrlKey && e.shiftKey && e.key == 'C') {
                e.preventDefault();
            }
            if (e.ctrlKey && e.shiftKey && e.key == 'J') {
                e.preventDefault();
            }
            if (e.ctrlKey && e.key == 'U') {
                e.preventDefault();
            }
        };

        window.addEventListener("keydown", (event)=>{
            if(event.keyCode == 89 && event.ctrlKey){
                if (_ImageData) {
                    ctx.putImageData(_ImageData, 0, 0);
                    for (i=0; i<=inputNum-1; i++){
                        console.log(document.getElementById(i+"Id"));
                        document.getElementById(i+"Id").removeAttribute("hidden");
                    };
                    _ImageData = 0;
                }else {
                    _ImageData = ctx.getImageData(0, 0, 1700, 930);
                    ctx.clearRect(0, 0, 1700, 930);
                    for (i=0; i<=inputNum-1; i++){
                        console.log(document.getElementById(i+"Id"));
                        document.getElementById(i+"Id").hidden = "true";
                    };
                    var x = 50, y = 50;
                    windows.forEach((item) => {
                        ctx.rect(x, y, 100, 100);
                        ctx.fillText(item.name, x+5, y + 25);
                        ctx.stroke();
                        x += 100;
                    });
                }
            }else if(event.keyCode==27){
                mode = 1;
            }else if(event.keyCode==80 && mode == 1){
                mode = 0;
            }else if(event.keyCode == 39 && mode == 1){ // Right
                layer = MoveRight(layer);
            }else if(event.keyCode == 37 && mode == 1){ // Left
                layer = MoveLeft(layer);
            }else if(event.ctrlKey && event.key === 'w'){
                ev.preventDefault();
                alert("HII");
            }else{
                console.log(event.keyCode);
            };
        });
        ctx.fillStyle = "grey";
        ctx.fillRect(0, 750, 1400, 60);
        const d = new Date();
        const year = 1000 * 60 * 60 * 24 * 365;
        let years = Math.round(d.getTime() / year);
        ctx.font = "20px Arial";
        ctx.fillStyle = "black";
        date = (d.getMonth() + 1) + "/" + (d.getDate()) + "/"+String(years + 1969).substring(2);
        ctx.fillText(date, 10, 780);
        createClick(0, 740, 110, 50, (event) => {
            console.log("Opening the time");
        });

        document.getElementById("star").addEventListener("load", (e) => {
            ctx.drawImage(document.getElementById("star"), 120, 743, 48, 48);
            createClick(120, 743, 48, 48, ()=>{
                Game("RedGame");
            });
        })

        document.getElementById("login").addEventListener("load", (e) => {
            ctx.drawImage(document.getElementById("login"), 180, 747, 40, 40);
            createClick(180, 747, 40, 40, ()=>{
                Game("Login");
            });
        })
    }
</script>

</body>
</html>

