<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OS</title>
</head>
<body>

<img id="star" width="200" height="220" src="assets/star.png" hidden>
<canvas id="os" width="1450" height="789" tabindex='1'>
Your browser does not support the HTML canvas tag.</canvas>

<script>
    var canvas = document.getElementById("os");
    var ctx = canvas.getContext("2d");
    var clickableElements = [];
    var windows = [];
    ctx.font = "30px Arial";
    function createClick(x, y, width, height, clicked){
        clickableElements.push({x:x, y:y, width:width, height:height, code:clickableElements.length, functionOnClicked:clicked});
    };
    canvas.addEventListener('click', function(event) {
        const rect = canvas.getBoundingClientRect(); // Get canvas bounds
        const mouseX = event.clientX - rect.left; // Mouse X position relative to canvas
        const mouseY = event.clientY - rect.top; // Mouse Y position relative to canvas
        clickableElements.forEach((el) => {
        if (mouseX > el.x && mouseX < el.x + el.width && mouseY > el.y && mouseY < el.y + el.height) {
            el.functionOnClicked();
        }
        });
    });
    function createButton(x, y, width, height, title){
        ctx.fillStyle = "grey";
        ctx.fillRect(x, y, width, height);
        ctx.font = "20px Arial";
        ctx.fillStyle = "black";
        const textMetrics = ctx.measureText(title);
        const textWidth = textMetrics.width;
        ctx.fillText(title, x + (width - textWidth) / 2, y + (height + parseInt(ctx.font, 10)) / 2 - 5);
    };
    function createOnClickButton(x, y, width, height, title, onClick){
        createButton(x, y, width, height, title);
        createClick(x, y, width, height, onClick);
    };
    function Window1(x, y, width, height, title, win){
        clickableElements = JSON.parse("[{\"x\":0,\"y\":740,\"width\":110,\"height\":50,\"code\":0},{\"x\":120,\"y\":743,\"width\":48,\"height\":48,\"code\":1}]");
        clickableElements[0].functionOnClicked = (event) => {
            console.log("Opening the time");
        };
        clickableElements[1].functionOnClicked = (event) => {
            Game("RedGame");
        };
        win.ImageData = ctx.getImageData(x, y, width, height);
        ctx.rect(x, y, width, height);
        ctx.stroke();
        ctx.rect(x, y, width, 30);
        ctx.stroke();
        ctx.fillText(title, x+10, y+25);
        ctx.fillStyle = "black";
        ctx.fillText("-", x+width-90, y+25);
        ctx.fillText("x", x+width-30, y+25);
        ctx.fillText("â– ", x+width-60, y+25);
        win.ImageData = ctx.getImageData(x, y, width, height);
        createClick(x+width-90, y, 10, 30, ()=>{
            console.log("-");
        });
        createClick(x+width-30, y, 10, 30, ()=>{
            console.log(windows);
            win.ImageData = ctx.getImageData(x, y, width, height);
            windows = windows.filter((_, index) => index !== win.id);;
            ctx.clearRect(x, y, width+1, height+1);
            ctx.fillStyle = "white";
            // ctx.clearRect(windows.length * 100, 30, ctx.measureText(winname).width(), 30);
            console.log(ctx.measureText(win.winname));
            ctx.clearRect(windows.length * 100, 0, ctx.measureText(win.winname).width, 30);
            ctx.fillStyle = "black";
            ctx.fillRect(windows.length * 100, 0, ctx.measureText(win.winname).width+2, 30);
        });
        createClick(x+width-60, y, 10, 30, ()=>{
            console.log("BOX");
        });
    };
    function Game(name){
        winname = windows.length;
        ctx.clearRect(0, 40, 900, 700);
        ctx.fillStyle = "white";
        ctx.fillText(winname, windows.length * 100, 30);
        win = {name:name, layer:windows.length, id:windows.length, winname:winname};
        windows.push(win);
        ctx.fillStyle = "black";
        Window1(0, 40, 1400, 700, winname, win);
    };
    if (!localStorage.OSBooted) {
        localStorage.OSBooted = true;
        ctx.rect(10,15,300,200);
        ctx.stroke();
        ctx.fillText("Welcome To", 80, 50);
        ctx.font = "50px Arial";
        ctx.fillText("VishnuOS", 50, 100);
        createOnClickButton(105, 150, 100, 40, "Tutorial", (click) => {
            ctx.clearRect(0, 0, 1000, 1000);
            ctx.fillText("No thank you. Just go back. At least you learned that Ctrl-Y opens the view to see your windows! Also Esc brings you to the page mode where you can choose your page and can go back by pressing p", 40, 50);
            createOnClickButton(80, 100, 100, 40, "Go Back", (click) => {
                localStorage.OSBooted = false;
                window.location.reload();
            });
        });
    }else {
        var _ImageData;
        var mode = 0;
        var layer = -1;
        ctx.fillRect(0, 0, 1700, 40);
        window.addEventListener("keydown", (event)=>{
            if(event.keyCode == 89){
                if (_ImageData) {
                    ctx.putImageData(_ImageData, 0, 0);
                    _ImageData = 0;
                }else {
                    _ImageData = ctx.getImageData(0, 0, 1700, 930);
                    ctx.clearRect(0, 0, 1700, 930);
                    var x = 50, y = 50;
                    windows.forEach((item) => {
                        ctx.rect(x, y, 100, 100);
                        ctx.fillText(item.name, x+5, y + 25);
                        ctx.stroke();
                        x += 100;
                    });
                }
            }else if(event.keyCode==27){
                mode = 1;
            }else if(event.keyCode==80 && mode == 1){
                mode = 0;
            }else if(event.keyCode == 39 && mode == 1){ // Right
                if (layer != -1 && layer < windows.length){
                    console.log("HI");
                    windows[layer].ImageData = ctx.getImageData(0, 40, 1400, 700);
                    ctx.putImageData(windows[layer+1].ImageData, 0, 40);
                    layer++;
                }
            }else if(event.keyCode == 37 && mode == 1){ // Left
                if (layer == -1 && layer < windows.length){
                    if (windows.length != 1) {
                        layer = windows.length-1;
                    }else{
                        layer = 1;
                    }
                };
                console.log(windows[layer].ImageData, windows[layer-1].ImageData);
                windows[layer].ImageData = ctx.getImageData(0, 40, 1400, 700);
                ctx.putImageData(windows[layer-1].ImageData, 0, 40);
                layer--;
            }else{
                console.log(event.keyCode);
            };
        });
        ctx.fillStyle = "grey";
        ctx.fillRect(0, 750, 1400, 60);
        const d = new Date();
        const year = 1000 * 60 * 60 * 24 * 365;
        let years = Math.round(d.getTime() / year);
        ctx.font = "20px Arial";
        ctx.fillStyle = "black";
        date = (d.getMonth() + 1) + "/" + (d.getDate()) + "/"+String(years + 1969).substring(2);
        ctx.fillText(date, 10, 780);
        createClick(0, 740, 110, 50, (event) => {
            console.log("Opening the time");
        });

        document.getElementById("star").addEventListener("load", (e) => {
            ctx.drawImage(document.getElementById("star"), 120, 743, 48, 48);
            createClick(120, 743, 48, 48, ()=>{
                Game("RedGame");
            });
        })
    }
</script>

</body>
</html>

